# Intel SGX 换页惩罚参数分析与优化建议

本文针对 MEDIA 算法中关于 TEE（Trusted Execution Environment）换页惩罚参数的设置进行分析。针对 Intel SGX 技术特性，评估当前参数的合理性并提出优化方案。

## 1. 当前参数设置现状

在 `common.py` 和 `alg_media.py` 中，当前的惩罚机制定义如下：

*   **参数**: `SWITCH_OVERHEAD = 0.5`
*   **计算公式**:
    ```python
    if p.total_memory > EPC_EFFECTIVE_MB:
        penalty = 0.5
    exec_t = p.total_workload / (s.power_ratio * penalty)
    ```
*   **实质含义**: 当分区内存超过 EPC 上限时，执行效率降低至 50%，即**耗时变为原来的 2 倍**（2x Overhead）。

## 2. Intel SGX 换页机制与开销分析

### SGX 换页原理
Intel SGX 的 EPC（Enclave Page Cache）物理内存有限（通常为 128MB，可用约 93MB）。当 Enclave 访问的内存页不在 EPC 中时，SGX 驱动程序必须执行昂贵的换页操作（Paging）：
1.  **EWB (Evict Write Back)**: 将 EPC 中的页面加密、生成消息认证码 (MAC) 并写回不可信的主存（DRAM）。
2.  **ELDU (Enclave Load Unblocked)**: 从主存读取页面，进行完整性校验（验证 MAC）和解密，重新放入 EPC。
3.  **模式切换**: 涉及用户态与内核态的频繁切换，以及 Enclave 的退出 (EEXIT) 和重入 (EENTER)。

### 开销特征
学术界（如 Eleos, Glamdring 等论文）的研究表明，SGX 换页开销具有以下特征：
1.  **极其昂贵**: 单次换页涉及复杂的加密计算和上下文切换，开销远高于普通 OS 换页。
2.  **非线性**: 随着工作集大小（Working Set Size）超出 EPC 的比例增加，系统可能会陷入“颠簸”（Thrashing）状态，性能下降不是线性的，而是指数级的。
3.  **典型数据**:
    *   对于顺序访问（DNN 卷积常见），性能下降通常在 **2x - 5x** 之间。
    *   对于随机访问，性能下降可达 **10x - 20x** 甚至更高。

## 3. 合理性评估

**结论：当前的 2x 惩罚（0.5 系数）偏向乐观，且模型过于简化。**

*   **乐观性**: 虽然 DNN 推理主要是张量运算（局部性较好），但如果内存显著超限（例如 200MB vs 93MB EPC），频繁的页面置换会导致只有极少时间在做计算，2x 的预估可能不足以覆盖实际开销。
*   **僵化性**: 当前算法是一个“阶跃函数”——只要超 1字节，惩罚就是 2x；超 100MB，惩罚还是 2x。这不符合物理规律。超限越多，换页频率越高，惩罚应越大。

## 4. 优化建议：构建动态惩罚模型

为了更真实地模拟 SGX 行为，建议摈弃固定的 `0.5` 参数，改用**基于超限比例的线性或非线性模型**。

### 方案 A：线性比例惩罚（推荐）
假设惩罚与“溢出内存量”成正比。

*   **公式**:
    $$ PenaltyFactor = 1 + \alpha \times \frac{\max(0, Mem_{total} - EPC)}{EPC} $$
*   **参数 $\alpha$**: 敏感度系数。
    *   如果 $\alpha=2$，当内存为 2倍 EPC 时，耗时变为 3倍。
    *   建议设置 $\alpha \in [2, 5]$。

### 方案 B：分段阶梯惩罚
如果不想引入复杂计算，可以设置更激进的固定阈值：
*   **轻微超限** (<110%): 2x 惩罚 (系数 0.5)
*   **严重超限** (>150%): 5x 惩罚 (系数 0.2)
*   **极端超限** (>200%): 10x 惩罚 (系数 0.1)

## 5. 预期影响
如果采用更严格的惩罚模型（例如动态模型），**MEDIA 算法的行为将发生变化**：
它会发现“硬撑着不拆分”的代价变得极大，从而在某些情况下**被迫选择拆分**，这可能会使它的决策向 DINA 靠拢，或者在某些边缘 case 下找到更优的平衡点（拆分一部分，保留一部分超限）。
